# ì¸ì¦ì„œ ë° í‚¤ íŒŒì¼ ëª©ë¡
CERTS_DIR = certs
CERTS = $(CERTS_DIR)/root_ca.key $(CERTS_DIR)/root_ca.pem $(CERTS_DIR)/root_ca.srl \
        $(CERTS_DIR)/server.key $(CERTS_DIR)/server.csr $(CERTS_DIR)/server.crt \
        $(CERTS_DIR)/client1.key $(CERTS_DIR)/client1.csr $(CERTS_DIR)/client1.crt \
        $(CERTS_DIR)/client2.key $(CERTS_DIR)/client2.csr $(CERTS_DIR)/client2.crt

# (ì‚¬ìš©ìê°€ ì§ì ‘ ë§Œë“¤ì–´ì•¼ í• ) openssl ì„¤ì • íŒŒì¼ ê²½ë¡œ
OPENSSL_CNF = openssl.cnf

.PHONY: all ca server client1 client2 clean revoke-client2

# ë””ë ‰í„°ë¦¬ ìƒì„±
$(CERTS_DIR):
	mkdir -p $(CERTS_DIR)

# ğŸ”¹ 1ï¸âƒ£ CA ì¸ì¦ì„œ ìƒì„±
ca: $(CERTS_DIR)
	@echo "ğŸ”¹ CA ì¸ì¦ì„œ ìƒì„± ì¤‘..."
	@openssl req -x509 -newkey rsa:4096 -nodes -sha256 -days 3650 \
	    -keyout $(CERTS_DIR)/root_ca.key -out $(CERTS_DIR)/root_ca.pem \
	    -subj "/C=KR/ST=Seoul/L=Gangnam/O=MyCompany/OU=IT/CN=My CA" -quiet
	@echo "âœ… CA ì¸ì¦ì„œ ìƒì„± ì™„ë£Œ!"

# ğŸ”¹ ì„œë²„ ì¸ì¦ì„œ ìƒì„± (ì„ íƒ ì‚¬í•­)
server: $(CERTS_DIR) ca
	@echo "ğŸ”¹ ì„œë²„ ì¸ì¦ì„œ ìƒì„± ì¤‘..."
	@openssl req -newkey rsa:4096 -nodes -keyout $(CERTS_DIR)/server.key -out $(CERTS_DIR)/server.csr \
	    -subj "/C=KR/ST=Seoul/L=Gangnam/O=MyCompany/OU=IT/CN=myserver.com" -quiet
	@openssl x509 -req -in $(CERTS_DIR)/server.csr -CA $(CERTS_DIR)/root_ca.pem -CAkey $(CERTS_DIR)/root_ca.key -CAcreateserial \
	    -out $(CERTS_DIR)/server.crt -days 3650 -sha256
	@echo "âœ… ì„œë²„ ì¸ì¦ì„œ ìƒì„± ì™„ë£Œ!"

# ğŸ”¹ 2ï¸âƒ£ í´ë¼ì´ì–¸íŠ¸1 ì¸ì¦ì„œ ìƒì„± (ì¸ì¦ í—ˆìš©)
client1: $(CERTS_DIR) ca
	@echo "ğŸ”¹ í´ë¼ì´ì–¸íŠ¸1 ì¸ì¦ì„œ ìƒì„± ì¤‘ (ì¸ì¦ í—ˆìš©)..."
	@openssl req -newkey rsa:4096 -nodes -keyout $(CERTS_DIR)/client1.key -out $(CERTS_DIR)/client1.csr \
	    -subj "/C=KR/ST=Seoul/L=Gangnam/O=YourCompany/OU=allowed/CN=client1" -quiet
	@openssl x509 -req -in $(CERTS_DIR)/client1.csr -CA $(CERTS_DIR)/root_ca.pem -CAkey $(CERTS_DIR)/root_ca.key -CAcreateserial \
	    -out $(CERTS_DIR)/client1.crt -days 3650 -sha256
	@echo "âœ… í´ë¼ì´ì–¸íŠ¸1 ì¸ì¦ì„œ ìƒì„± ì™„ë£Œ!"

# ğŸ”¹ 3ï¸âƒ£ í´ë¼ì´ì–¸íŠ¸2 ì¸ì¦ì„œ ìƒì„± (ì¸ì¦ ê±°ë¶€)
client2: $(CERTS_DIR) ca
	@echo "ğŸ”¹ í´ë¼ì´ì–¸íŠ¸2 ì¸ì¦ì„œ ìƒì„± ì¤‘ (ì¸ì¦ ê±°ë¶€)..."
	@openssl req -newkey rsa:4096 -nodes -keyout $(CERTS_DIR)/client2.key -out $(CERTS_DIR)/client2.csr \
	    -subj "/C=KR/ST=Seoul/L=Gangnam/O=YourCompany/OU=denied/CN=client2" -quiet
	@openssl x509 -req -in $(CERTS_DIR)/client2.csr -CA $(CERTS_DIR)/root_ca.pem -CAkey $(CERTS_DIR)/root_ca.key -CAcreateserial \
	    -out $(CERTS_DIR)/client2.crt -days 3650 -sha256
	@echo "âœ… í´ë¼ì´ì–¸íŠ¸2 ì¸ì¦ì„œ ìƒì„± ì™„ë£Œ!"

# ğŸ”¹ client2 ì¸ì¦ì„œ Revoke í›„ CRL ìƒì„±
revoke-client2: $(CERTS_DIR)/root_ca.pem $(CERTS_DIR)/root_ca.key $(CERTS_DIR)/client2.crt
	@echo "ğŸ”¹ client2 ì¸ì¦ì„œ íê¸° ë° CRL ìƒì„± ì¤‘..."

	# CA DB ê´€ë ¨ íŒŒì¼ì´ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìƒˆë¡œ ìƒì„±(ì¡´ì¬í•˜ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
	@touch $(CERTS_DIR)/index.txt
	@[ -f $(CERTS_DIR)/crlnumber ] || echo 1000 > $(CERTS_DIR)/crlnumber

	# client2 ì¸ì¦ì„œ íê¸° ì²˜ë¦¬
	@openssl ca -config $(OPENSSL_CNF) \
	    -revoke $(CERTS_DIR)/client2.crt \
	    -keyfile $(CERTS_DIR)/root_ca.key \
	    -cert $(CERTS_DIR)/root_ca.pem \
	    -batch -crl_reason superseded -quiet

	# CRL ìƒì„±
	@openssl ca -config $(OPENSSL_CNF) \
	    -gencrl -out $(CERTS_DIR)/root_ca.crl \
	    -batch -quiet

	@echo "âœ… client2 ì¸ì¦ì„œ íê¸° ë° CRL ìƒì„± ì™„ë£Œ!"
	@echo "    â‡’ ìƒì„±ëœ CRL íŒŒì¼: $(CERTS_DIR)/root_ca.crl"

up:
	docker compose up -d

down:
	docker compose down

# ì „ì²´ ì¸ì¦ì„œ ìƒì„±
create-certs: ca server client1 client2 revoke-client2

tests:
	@echo "Running all tests and collecting HTTP responses (status code only)..."
	@RESULT1="$$(curl -s -o /dev/null -w "%{http_code}" --resolve 'myserver.com:8880:127.0.0.1' https://myserver.com:8880 --cacert $(CERTS_DIR)/root_ca.pem || echo 'ERROR')"; \
	RESULT2="$$(curl -s -o /dev/null -w "%{http_code}" --cert $(CERTS_DIR)/client1.crt --key $(CERTS_DIR)/client1.key --cacert $(CERTS_DIR)/root_ca.pem --resolve 'myserver.com:8881:127.0.0.1' https://myserver.com:8881 || echo 'ERROR')"; \
	RESULT3="$$(curl -s -o /dev/null -w "%{http_code}" --cert $(CERTS_DIR)/client2.crt --key $(CERTS_DIR)/client2.key --cacert $(CERTS_DIR)/root_ca.pem --resolve 'myserver.com:8881:127.0.0.1' https://myserver.com:8881 || echo 'ERROR')"; \
	RESULT4="$$(curl -s -o /dev/null -w "%{http_code}" --cert $(CERTS_DIR)/client1.crt --key $(CERTS_DIR)/client1.key --cacert $(CERTS_DIR)/root_ca.pem --resolve 'myserver.com:8882:127.0.0.1' https://myserver.com:8882 || echo 'ERROR')"; \
	RESULT5="$$(curl -s -o /dev/null -w "%{http_code}" --cert $(CERTS_DIR)/client2.crt --key $(CERTS_DIR)/client2.key --cacert $(CERTS_DIR)/root_ca.pem --resolve 'myserver.com:8882:127.0.0.1' https://myserver.com:8882 || echo 'ERROR')"; \
	\
	echo "\n================== Test Results =================="; \
	printf "| %-50s | %-10s |\n" "Test Name" "HTTP Code"; \
	echo "----------------------------------------------------------------------------"; \
	printf "| %-50s | %-10s |\n" "TLS (port 8880)" "$$RESULT1"; \
	printf "| %-50s | %-10s |\n" "mTLS (port 8881) with client1 certificate" "$$RESULT2"; \
	printf "| %-50s | %-10s |\n" "mTLS (port 8881) with client2 certificate" "$$RESULT3"; \
	printf "| %-50s | %-10s

clean:
	@echo "ğŸ”¹ ì¸ì¦ì„œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
	@rm -rf $(CERTS_DIR)
	@echo "âœ… ì¸ì¦ì„œ ë° certs ë””ë ‰í„°ë¦¬ ì‚­ì œ ì™„ë£Œ!"
